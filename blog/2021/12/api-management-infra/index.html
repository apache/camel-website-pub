<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../../../apple-touch-icon-57x57.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../../../apple-touch-icon-114x114.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../../../apple-touch-icon-72x72.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../../../apple-touch-icon-144x144.png"> <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../../../../apple-touch-icon-60x60.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../../../../apple-touch-icon-120x120.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../../../../apple-touch-icon-76x76.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../../../apple-touch-icon-152x152.png"> <link rel="icon" type="image/png" href="../../../../favicon-196x196.png" sizes="196x196"> <link rel="icon" type="image/png" href="../../../../favicon-96x96.png" sizes="96x96"> <link rel="icon" type="image/png" href="../../../../favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="../../../../favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="../../../../favicon-128.png" sizes="128x128"> <meta name="application-name" content="Apache Camel"> <meta property="og:title" content="A high-security API management infrastructure using Apache Camel"> <meta property="og:site_name" content="Apache Camel"> <meta property="og:url" content="https://camel.apache.org/blog/2021/12/api-management-infra/"> <meta name="og:description" content="How a high-security API management infrastructure is implemented using Camel and Keycloak"> <meta property="og:type" content="website"> <meta property="og:image" content="https://camel.apache.org/_/img/logo-d.svg"> <link rel="manifest" href="../../../../site.webmanifest"> <title>A high-security API management infrastructure using Apache Camel - Apache Camel</title> <link rel="canonical" href="https://camel.apache.org/blog/2021/12/api-management-infra/"> <link rel="stylesheet" href="../../../../_/css/site-b287b96c63.css"> </head> <body class="article"> <header class="header" aria-label="Header"> <nav class="navbar" aria-label="Main menu"> <div class="navbar-brand"> <a class="nav-logo" href="../../../../" title="Apache Camel"></a> <div id="topbar-nav" class="navbar-menu"> <div class="navbar-end"> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../blog/"> <img alt="Blog" src="../../../../_/img/blog-4c7fa4cb60.svg"> Blog </a> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../docs/"> <img alt="Documentation" src="../../../../_/img/documentation-abb1b7f8b1.svg"> Documentation </a> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../community/"> <img alt="Community" src="../../../../_/img/community-2ec8a3dc8b.svg"> Community </a> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../download/"> <img alt="Download" src="../../../../_/img/download-63cdd75074.svg"> Download </a> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../security/"> <img alt="Security" src="../../../../_/img/security-06abe157b3.svg"> Security </a> </div> </div> <div class="navbar-fill"></div> <div class="break-row"></div> <div class="navbar-search results-hidden"> <input id="search" class="search" placeholder="Search" autocomplete="off"> <img src="/_/img/cancel-1ed239489b.svg" alt="Clear" id="search-cancel"> <div id="search_results"></div> </div> <div class="navbar-tools"> <a rel="noopener noreferrer nofollow" href="https://github.com/apache/camel/" title="Collaborate on GitHub"><svg focusable="false" class="brand-icon"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#github"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://camel.zulipchat.com" title="Chat on Zulip"><svg focusable="false" class="brand-icon"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#zulip"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://twitter.com/ApacheCamel" title="Follow Apache Camel on Twitter"><svg focusable="false" class="brand-icon"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#twitter"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://www.linkedin.com/groups/2447439/" title="Apache Camel group on Linkedin"><svg focusable="false" class="brand-icon"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#linkedin"/></svg></a> </div> <button class="navbar-burger" data-target="topbar-nav" type="button" aria-label="Menu"> <span></span> <span></span> <span></span> </button> </div> </nav> </header> <a id="top"></a> <div class="body"> <main role="main blog"> <article class="blog doc"> <header aria-labelledby="title"> <a class="category" href="../../../../categories/Usecases/">USECASES</a> <h1 id="title">A high-security API management infrastructure using Apache Camel</h1> </header> <div class="post"> <aside aria-label="Post details"> <div class="summary">How a high-security API management infrastructure is implemented using Camel and Keycloak</div> Posted on <time itemprop="published" datetime="2021-12-14" title="Tuesday, December 14, 2021">December 14, 2021</time>, by <figure> <img src="https://avatars.githubusercontent.com/u/64939232?v=4" alt="Yang Xie"> <figcaption rel="author">Yang Xie</figcaption> </figure> <h4>Share this blog</h4> <a class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcamel.apache.org%2fblog%2f2021%2f12%2fapi-management-infra%2f" target="_blank" rel="noopener" aria-label="Share on Facebook"> <div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" focusable="false"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg> </div> </div> </a> <a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?text=A%20high-security%20API%20management%20infrastructure%20using%20Apache%20Camel&url=https%3a%2f%2fcamel.apache.org%2fblog%2f2021%2f12%2fapi-management-infra%2f&hashtags=ApacheCamel" target="_blank" rel="noopener" aria-label="Share on Twitter"> <div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" focusable="false"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5 0-4.55 2.04-4.55 4.54 0 .36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3 0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35 0 12.92-6.92 12.92-12.93 0-.2 0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg> </div> </div> </a> <a class="resp-sharing-button__link" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fcamel.apache.org%2fblog%2f2021%2f12%2fapi-management-infra%2f&title=A%20high-security%20API%20management%20infrastructure%20using%20Apache%20Camel&summary=How%20a%20high-security%20API%20management%20infrastructure%20is%20implemented%20using%20Camel%20and%20Keycloak&source=https%3A%2F%2Fcamel.apache.org" target="_blank" rel="noopener" aria-label="Share on LinkedIn" title="Share on LinkedIn"> <div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" focusable="false"><path d="M6.5 21.5h-5v-13h5v13zM4 6.5C2.5 6.5 1.5 5.3 1.5 4s1-2.4 2.5-2.4c1.6 0 2.5 1 2.6 2.5 0 1.4-1 2.5-2.6 2.5zm11.5 6c-1 0-2 1-2 2v7h-5v-13h5V10s1.6-1.5 4-1.5c3 0 5 2.2 5 6.3v6.7h-5v-7c0-1-1-2-2-2z"/></svg> </div> </div> </a> <p> <a class="arrow prev" href="../../../../blog/2021/12/log4j2/" title="Previous post: Apache Camel and CVE-2021-44228 (log4j)">&#10094;</a> <a class="arrow next" href="../../../../blog/2021/12/RELEASE-3.14.0/" title="Next post: RELEASE 3.14.0">&#10095;</a> </p> </aside> <div class="post-content"> <p>I&rsquo;m an engineer working at the OSS solution center of Hitachi, Ltd. Hitachi, Ltd. is a company that provides IT services &amp; platforms in Japan and other countries. In our organization, OSS solution center, we are working on providing the IT services with the OSS. In my case, I&rsquo;m working on Keycloak, 3scale and Camel, providing the technical support and considering the use cases of them. And I&rsquo;m also an open source contributor for Keycloak.</p> <h2 id="api-management-infrastructure">API management infrastructure</h2> <p>When being used as an API Gateway, Apache Camel (hereinafter called &ldquo;Camel&rdquo;) can use its various functions like protocol conversion and mash-up to support complex requirements flexibly. By adding Keycloak as an OAuth 2.0 authorization server, we can obtain an API management infrastructure which can also perform API authentication.</p> <h3 id="what-is-keycloak">What is Keycloak?</h3> <p>Keycloak is an identity and access management OSS. As an OAuth 2.0 authorization server, Keycloak supports OAuth 2.0 and a part of related standards, that will play a big role in a later chapter.</p> <h3 id="architecture-overview">Architecture Overview</h3> <p>As shown in the picture below, the API management infrastructure can perform reverse proxy, protocol conversion, data conversion, mash-up, flow control, API documentation publishing and metrics. Besides, it also can perform simple API authorization by token issuance &amp; management that is provided by Keycloak.</p> <figure> <a href="../../../../blog/2021/12/api-management-infra/API-management-infrastructure.png" title="API management infrastructure (Click to enlarge)"><img src="../../../../blog/2021/12/api-management-infra/API-management-infrastructure_hu0d3c3824068f5dbba891086bc4ebdd28_149927_800x0_resize_q95_gaussian_3.png" width="800" height="323" alt="API management infrastructure"></a> <figcaption>API management infrastructure (Click to enlarge)</figcaption> </figure> <h2 id="drawbacks-of-security">Drawbacks of security</h2> <p>Although the existing API management infrastructure has taken a security measure as token issuance &amp; management, there are also three drawbacks of its security:</p> <ol> <li>Inadequate token validation.</li> <li>No API access management for each API.</li> <li>No prevention for token stealing.</li> </ol> <p>All drawbacks will cause API abuse. I&rsquo;ll explain them in detail in the following.</p> <h3 id="drawback-1-inadequate-token-validation">Drawback 1: Inadequate token validation</h3> <p>The existing API management infrastructure only does minimal validations such as checking signature and expiration time after receiving an access token. Because an access token can be invalidated before its expiration time (as an &ldquo;inactive&rdquo; access token), only doing the minimal validations may incorrectly determine an inactive access token as valid. Attackers can use such inactive access tokens to access the API.</p> <h3 id="drawback2-no-access-management-for-each-api">Drawback2: No access management for each API</h3> <p>The existing API management infrastructure have no access management for each API. As a result, anyone can access an arbitrary API with full authority. It will lead to many security issues, as well as a large risk for data breaches.</p> <h3 id="drawback3-no-prevention-for-token-stealing">Drawback3: No prevention for token stealing</h3> <p>The existing API management infrastructure have no prevention for access token stealing. Attackers can use a stolen access token to access the API.</p> <h2 id="security-enhancement-with-keycloak">Security enhancement with Keycloak</h2> <p>For overcoming the security drawbacks, we can use three mechanisms defined in OAuth 2.0 and its related standards. They&rsquo;re token introspection, scope check and OAuth MTLS. All of them are supported by Keycloak. I&rsquo;ll explain them in detail in the following, and show you how to implement them by developing Camel applications with the support of Keycloak.</p> <h3 id="token-introspection">Token introspection</h3> <figure> <a href="../../../../blog/2021/12/api-management-infra/Token-introspection.png" title="Token introspection (Click to enlarge)"><img src="../../../../blog/2021/12/api-management-infra/Token-introspection_hub8129f6af66ff7d158450d4c9527012e_76547_800x0_resize_q95_gaussian_3.png" width="800" height="221" alt="Token introspection"></a> <figcaption>Token introspection (Click to enlarge)</figcaption> </figure> <p>Token introspection is a mechanism for validating access token by requesting an authorization server. It is defined in <a href="https://datatracker.ietf.org/doc/html/rfc7662" rel="noopener nofollow noreferrer">RFC7662</a>, a related standard of OAuth 2.0.</p> <p>In token introspection, API gateway sends an introspection request that includes the access token to validate to the authorization server. Introspection request uses POST method and &ldquo;application/x-www-form-urlencoded&rdquo; content type, and includes the access token in the request body as a parameter called token.</p> <p>The following is an example introspection request.</p> <pre tabindex="0"><code>  POST /introspect HTTP/1.1
  Host: server.example.com
  Accept: application/json
  Content-Type: application/x-www-form-urlencoded

  token=2YotnFZFEjr1zCsicMWpAA
</code></pre><p>Usually, the introspection response includes a set of information about the access token if it is active.</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;active&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;client_id&#34;</span><span class="p">:</span> <span class="s2">&#34;l238j323ds-23ij4&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;jdoe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;scope&#34;</span><span class="p">:</span> <span class="s2">&#34;read write dolphin&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;Z5O3upPC88QrAjx00dis&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;aud&#34;</span><span class="p">:</span> <span class="s2">&#34;https://protected.example.net/resource&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iss&#34;</span><span class="p">:</span> <span class="s2">&#34;https://server.example.com/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;exp&#34;</span><span class="p">:</span> <span class="mi">1419356238</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iat&#34;</span><span class="p">:</span> <span class="mi">1419350238</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;extension_field&#34;</span><span class="p">:</span> <span class="s2">&#34;twenty-seven&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>If the access token is not active, the following response is returned instead.</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;active&#34;</span><span class="p">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="support-in-keycloak">Support in Keycloak</h4> <p>For supporting token introspection, Keycloak provides an introspection endpoint to receive the introspection request.</p> <p>After receiving the introspection request, Keycloak inspects the access token with several steps including validate the session linked with the access token.</p> <p>Session is a data structure used in Keycloak for storing user&rsquo;s login information. Access token is generated from session and every access token is linked with one session. Access token and the linked session have the same value of their validities. Therefore, if the linked session is validated to invalid, the access token also will be validated to invalid even if its expiration time hasn&rsquo;t been reached.</p> <h4 id="development-in-camel">Development in Camel</h4> <p>API management infrastructure can use token introspection to confirm whether an access token is active.</p> <p>To add the function of token introspection to API management infrastructure, we can develop it in Camel by using HTTP4 component. In this case, HTTP4 component will be used for sending the introspection request and receiving the introspection response.</p> <p>the following is an sample that shows how to implement token inspection in Camel.</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">from</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//receive the API request from the client application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">setHeader</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//set the headers for requesting the inspection endpoint</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">setBody</span><span class="p">(</span><span class="n">simple</span><span class="p">(</span><span class="s">&#34;client_id=...&amp;amp;client_secret=...&amp;amp;token=...&#34;</span><span class="p">)</span><span class="w"> </span><span class="c1">//set the client authentication information and the access token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">to</span><span class="p">(</span><span class="s">&#34;http4://.../introspect&#34;</span><span class="p">)</span><span class="w"> </span><span class="c1">//send the inspection request to the inspection endpoint of Keycloak</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">choice</span><span class="p">()</span><span class="w"> </span><span class="c1">//check the response of token inspection</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">when</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//if access token was active</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setHeader</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//set the headers for requesting the backend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">recipientList</span><span class="p">(...);</span><span class="w"> </span><span class="c1">//request the backend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">otherwise</span><span class="p">()</span><span class="w"> </span><span class="c1">//if access token was inactive</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setHeader</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//set the error status code to 401</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setBody</span><span class="p">(...);</span><span class="w"> </span><span class="c1">//set the error response content</span><span class="w">
</span></span></span></code></pre></div><h4 id="effect">Effect</h4> <p>As a result of implementing token introspection, the API request with an inactive access token will be denied by security enhanced API management infrastructure (with a 401 response). It means the drawback 1 is overcome.</p> <h3 id="scope-check">Scope check</h3> <figure> <a href="../../../../blog/2021/12/api-management-infra/Scope-check.png" title="Scope check (Click to enlarge)"><img src="../../../../blog/2021/12/api-management-infra/Scope-check_hu05ed2c47a59c6dbccdfe3f957fba5701_65035_800x0_resize_q95_gaussian_3.png" width="800" height="240" alt="Scope check"></a> <figcaption>Scope check (Click to enlarge)</figcaption> </figure> <p>Scope is a mechanism for limiting an application&rsquo;s access to an API. It is defined in <a href="https://datatracker.ietf.org/doc/html/rfc6749" rel="noopener nofollow noreferrer">RFC6749</a>, the specification document of OAuth 2.0.</p> <p>After receiving the token request with the scopes specified in query parameters, authorization server issues an access token with a scope member. The value of the scope member is a list of space-delimited strings (the scopes granted to the access token).</p> <p>The following is an example access token with a scope member.</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iss&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.hitachi.com/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;aud&#34;</span><span class="p">:</span> <span class="s2">&#34;https://app1.hitachi.com/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;jdoe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;scope&#34;</span><span class="p">:</span> <span class="s2">&#34;read write dolphin&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iat&#34;</span><span class="p">:</span> <span class="mi">1458785796</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;exp&#34;</span><span class="p">:</span> <span class="mi">1458872196</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="support-in-keycloak-1">Support in Keycloak</h4> <p>When issuing an access token, Keycloak confirms which scopes have been granted to the client application, and writes the scopes into the access token.</p> <h4 id="development">Development</h4> <p>API management infrastructure can check the scopes included in access token to confirm whether the client application is allowed to access the requested API. If the required scope is not included, the API request will be denied.</p> <p>To add the function of scope check to API management infrastructure, we can develop it in Camel by using a processor. Processor is used for treating the message that flowing in Camel. Camel provides many kinds of default processors. And Camel also provides a processor interface for the developers to customize their own processors. In this case, we choose to use a customized processor, that is more suitable to our needs.</p> <p>the following is an sample that shows how to implement scope check in Camel.</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">from</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//receive the API request from the client application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">process</span><span class="p">(</span><span class="n">ScopeCheckProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="c1">//check the required scopes</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">choice</span><span class="p">()</span><span class="w"> </span><span class="c1">//check the result of the processor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">when</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//if the required scopes was exist</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setHeader</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//set the headers for requesting the backend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">recipientList</span><span class="p">(...);</span><span class="w"> </span><span class="c1">//request the backend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">otherwise</span><span class="p">()</span><span class="c1">//if the required scopes was not exist</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setHeader</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//set the error status code to 403</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setBody</span><span class="p">(...);</span><span class="w"> </span><span class="c1">//set the error response content</span><span class="w">
</span></span></span></code></pre></div><h4 id="effect-1">Effect</h4> <p>As a result of implementing scope check, the API request without granted authority (scope) will be denied by security enhanced API management infrastructure (with a 403 response). It means that the drawback 2 is overcome.</p> <h3 id="oauth-mtls">OAuth MTLS</h3> <figure> <a href="../../../../blog/2021/12/api-management-infra/OAuth-MTLS.png" title="OAuth MTLS (Click to enlarge)"><img src="../../../../blog/2021/12/api-management-infra/OAuth-MTLS_huf1ad71315278824e00acdf9207a9d40d_111441_800x0_resize_q95_gaussian_3.png" width="800" height="268" alt="OAuth MTLS"></a> <figcaption>OAuth MTLS (Click to enlarge)</figcaption> </figure> <p>OAuth MTLS is a mechanism for preventing token stealing attacks by using the client certificate of the client application. It is defined in <a href="https://datatracker.ietf.org/doc/html/rfc8705" rel="noopener nofollow noreferrer">RFC8705</a>, a related standard of OAuth 2.0.</p> <p>In OAuth MTLS, all the communication must use MTLS (Mutual TLS). It means that the communication from the client side also should present its certificate. As a result, the client certificate will be passed to the server side.</p> <p>The access token used in OAuth MTLS should present the client certificate of the client application using a cnf.x5t#S256 member. The value of the cnf.x5t#S256 member is the the SHA-256 thumbprint of the client certificate.</p> <p>The following is an example access token that has a cnf.x5t#S256 member.</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iss&#34;</span><span class="p">:</span> <span class="s2">&#34;https://example.hitachi.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;aud&#34;</span><span class="p">:</span> <span class="s2">&#34;https://app1.hitachi.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;jdoe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;iat&#34;</span><span class="p">:</span> <span class="mi">1458785796</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;exp&#34;</span><span class="p">:</span> <span class="mi">1458872196</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;cnf&#34;</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;x5t#S256&#34;</span><span class="p">:</span> <span class="s2">&#34;bwcK0esc3ACC3DB2Y5_lESsXE8o9ltc05O89jdN-dg2&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="support-in-keycloak-2">Support in Keycloak</h4> <p>After enabling the OAuth MTLS, when issuing an access token, Keycloak calculates the SHA-256 thumbprint of the client certificate, and writes the result into the cnf.x5t#S256 member.</p> <h4 id="development-1">Development</h4> <p>After receiving an API request with the client certificate, API manager infrastructure can compare the SHA-256 thumbprint of the client certificate and the value of the cnf.x5t#S256 member in the access token. If they are not matched, the API request will be denied.</p> <p>To add the function of OAuth MTLS to API management infrastructure, we can develop it in Camel by using a customized processor.</p> <p>The following is an sample that shows how to implement OAuth MTLS in Camel.</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">from</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//receive the API request from the client application</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">process</span><span class="p">(</span><span class="n">CertificateBindingProcessor</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="c1">//compare the SHA-256 thumbprint of the client certificate and the cnf.x5t#S256 member of the access token</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">choice</span><span class="p">()</span><span class="w"> </span><span class="c1">//check the result of the processor</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">when</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//if the the SHA-256 thumbprint and the cnf.x5t#S256 member was matched</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setHeader</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//set the headers for requesting the backend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">recipientList</span><span class="p">(...);</span><span class="w"> </span><span class="c1">//request the backend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">.</span><span class="na">otherwise</span><span class="p">()</span><span class="c1">//if the the SHA-256 thumbprint and the cnf.x5t#S256 member was not matched</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setHeader</span><span class="p">(...)</span><span class="w"> </span><span class="c1">//set the error status code to 403</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">.</span><span class="na">setBody</span><span class="p">(...);</span><span class="w"> </span><span class="c1">//set the error response content</span><span class="w">
</span></span></span></code></pre></div><h4 id="effect-2">Effect</h4> <p>As a result of implementing OAuth MTLS, if an API request is from a client application that is not the one which the access token is issued for, the API request will be denied by security enhanced API management infrastructure (with a 403 response). It means that a stolen access token can&rsquo;t be used, so that the drawback 3 is overcome.</p> <div class="related"> </div> </div> </div> </article> </main> </div> <div class="footer-tools"> <a title="Improve this document, receive free virtual hugs &hearts;" href="https://github.com/apache/camel-website/edit/main/content/blog/2021/12/api-management-infra/index.md">Edit this Page</a> <a href="#top" title="Reach the top of the page">Back to top</a> </div> <footer> <div class="footer"> <figure class="logo"> <img class="logo" src="../../../../_/img/logo-d-a567cee6fa.svg" alt="Apache Camel Logo" aria-label="white silhouette of a camel in front of a sand dune"> </figure> <input id="footer-toggle-overview" type="checkbox" title="Show/Hide Overview section"> <dl> <dt><label for="footer-toggle-overview">Overview</label><label for="footer-toggle-overview">&#65291;</label></dt> <dd><a href="../../../../blog/">Blog</a></dd> <dd><a href="../../../../docs/">Documentation</a></dd> <dd><a href="../../../../community/support/">Community</a></dd> <dd><a href="../../../../download/">Download</a></dd> </dl> <input id="footer-toggle-documentation" type="checkbox" title="Show/Hide Documentation section"> <dl> <dt><label for="footer-toggle-documentation">Documentation</label><label for="footer-toggle-documentation">&#65291;</label></dt> <dd><a href="../../../../manual/">User Manual</a></dd> <dd><a href="../../../../components/next/index.html">Components</a></dd> <dd><a href="../../../../camel-k/next/">Camel-K</a></dd> <dd><a href="../../../../camel-kafka-connector/next/">Camel Kafka Connector</a></dd> <dd><a href="../../../../camel-quarkus/next/">Camel Quarkus</a></dd> <dd><a href="../../../../camel-spring-boot/next/">Camel Spring Boot</a></dd> <dd><a href="../../../../camel-karaf/3.22.x/">Camel Karaf</a></dd> <dd><a href="../../../../manual/faq/index.html">FAQ</a></dd> </dl> <input id="footer-toggle-community" type="checkbox" title="Show/Hide Community section"> <dl> <dt><label for="footer-toggle-community">Community</label><label for="footer-toggle-community">&#65291;</label></dt> <dd><a href="../../../../community/support/">Support</a></dd> <dd><a href="../../../../community/contributing/">Contributing</a></dd> <dd><a href="../../../../community/mailing-list">Mailing Lists</a></dd> <dd><a href="../../../../community/user-stories/">User stories</a></dd> <dd><a href="../../../../community/articles/">Articles</a></dd> <dd><a href="../../../../community/books/">Books</a></dd> <dd><a href="../../../../community/team/">Team</a></dd> </dl> <input id="footer-toggle-about" type="checkbox" title="Show/Hide Acknowledgements section"> <dl> <dt><label for="footer-toggle-about">About</label><label for="footer-toggle-about">&#65291;</label></dt> <dd><a href="../../../../acknowledgments/">Acknowledgments</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/events/current-event.html" title="Apache Events">Apache Events</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/licenses/" title="License">License</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/security/" title="Security">Security</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/foundation/sponsorship.html" title="Sponsorship">Sponsorship</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/foundation/thanks.html" title="Thanks">Thanks</a></dd> </dl> <p class="remark"> &copy; 2004-2024 The <a href="https://apache.org">Apache Software Foundation</a>.<br> Apache Camel, Camel, Apache, the Apache feather logo, and the Apache Camel project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners. </p> <div class="resources"> <div class="context"> <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a> </div> <div class="context"> <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/foundation/policies/conduct">Code of Conduct</a> </div> <div class="context"> <a href="../../../../sitemap/">Sitemap</a> </div> </div> <div class="footer-icons"> <a rel="noopener noreferrer nofollow" href="https://github.com/apache/camel/" title="Collaborate on GitHub"><svg class="brand-icon" focusable="false"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#github"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://camel.zulipchat.com" title="Chat on Zulip"><svg class="brand-icon" focusable="false"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#zulip"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://twitter.com/ApacheCamel" title="Follow Apache Camel on Twitter"><svg class="brand-icon" focusable="false"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#twitter"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://www.linkedin.com/groups/2447439/" title="Apache Camel group on Linkedin"><svg class="brand-icon" focusable="false"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#linkedin"/></svg></a> </div> </div> </footer> <script src="../../../../_/js/vendor/algoliasearch-bad45193e2.js"></script> <script src="../../../../_/js/site-c215fb6972.js"></script> <script async src="../../../../_/js/vendor/highlight-621a10fe1b.js"></script> <script async src="../../../../_/js/vendor/svg4everybody-a0c573f2b9.js"></script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Organization", "name": "Apache Camel", "url": "https:\/\/camel.apache.org\/" , "sameAs": ["https://twitter.com/ApacheCamel"] , "logo": "https:\/\/camel.apache.org\/_\/img\/logo-d.svg" , "description": "Apache Camel ™ is a versatile open-source integration framework based on known Enterprise Integration Patterns. Camel empowers you to define routing and mediation rules in a variety of domain-specific languages, including a Java-based Fluent API, Spring or Blueprint XML Configuration files, and a Scala DSL." } </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "BreadcrumbList", "itemListElement": [{ "@type": "ListItem", "position": 1 , "item": { "@id": "https://camel.apache.org/", "name": "Apache Camel" } },{ "@type": "ListItem", "position": 2 , "item": { "@id": "https://camel.apache.org/blog/", "name": "blog" } },{ "@type": "ListItem", "position": 3 , "item": { "@id": "https://camel.apache.org/blog/2021/", "name": "2021" } },{ "@type": "ListItem", "position": 4 , "item": { "@id": "https://camel.apache.org/blog/2021/12/", "name": "12" } },{ "@type": "ListItem", "position": 5 , "item": { "@id": "https://camel.apache.org/blog/2021/12/api-management-infra/", "name": "api-management-infra" } }] } </script> </body> </html> 