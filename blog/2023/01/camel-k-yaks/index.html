<!doctype html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../../../../apple-touch-icon-57x57.png"> <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../../../../apple-touch-icon-114x114.png"> <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../../../../apple-touch-icon-72x72.png"> <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../../../apple-touch-icon-144x144.png"> <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../../../../apple-touch-icon-60x60.png"> <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../../../../apple-touch-icon-120x120.png"> <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../../../../apple-touch-icon-76x76.png"> <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../../../apple-touch-icon-152x152.png"> <link rel="icon" type="image/png" href="../../../../favicon-196x196.png" sizes="196x196"> <link rel="icon" type="image/png" href="../../../../favicon-96x96.png" sizes="96x96"> <link rel="icon" type="image/png" href="../../../../favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="../../../../favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="../../../../favicon-128.png" sizes="128x128"> <meta name="application-name" content="Apache Camel"> <meta property="og:title" content="Testing Camel K with YAKS"> <meta property="og:site_name" content="Apache Camel"> <meta property="og:url" content="https://camel.apache.org/blog/2023/01/camel-k-yaks/"> <meta name="og:description" content="How to verify a Camel K integration with YAKS - locally and on cloud infrastructure"> <meta property="og:type" content="website"> <meta property="og:image" content="https://camel.apache.org/blog/2023/01/camel-k-yaks/featured.png"> <link rel="manifest" href="../../../../site.webmanifest"> <title>Testing Camel K with YAKS - Apache Camel</title> <link rel="canonical" href="https://camel.apache.org/blog/2023/01/camel-k-yaks/"> <link rel="stylesheet" href="../../../../_/css/site-b287b96c63.css"> </head> <body class="article"> <header class="header" aria-label="Header"> <nav class="navbar" aria-label="Main menu"> <div class="navbar-brand"> <a class="nav-logo" href="../../../../" title="Apache Camel"></a> <div id="topbar-nav" class="navbar-menu"> <div class="navbar-end"> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../blog/"> <img alt="Blog" src="../../../../_/img/blog-4c7fa4cb60.svg"> Blog </a> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../docs/"> <img alt="Documentation" src="../../../../_/img/documentation-abb1b7f8b1.svg"> Documentation </a> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../community/"> <img alt="Community" src="../../../../_/img/community-2ec8a3dc8b.svg"> Community </a> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../download/"> <img alt="Download" src="../../../../_/img/download-63cdd75074.svg"> Download </a> <a class="navbar-item-section navbar-item navbar-topics" href="../../../../security/"> <img alt="Security" src="../../../../_/img/security-06abe157b3.svg"> Security </a> </div> </div> <div class="navbar-fill"></div> <div class="break-row"></div> <div class="navbar-search results-hidden"> <input id="search" class="search" placeholder="Search" autocomplete="off"> <img src="/_/img/cancel-1ed239489b.svg" alt="Clear" id="search-cancel"> <div id="search_results"></div> </div> <div class="navbar-tools"> <a rel="noopener noreferrer nofollow" href="https://github.com/apache/camel/" title="Collaborate on GitHub"><svg focusable="false" class="brand-icon"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#github"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://camel.zulipchat.com" title="Chat on Zulip"><svg focusable="false" class="brand-icon"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#zulip"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://twitter.com/ApacheCamel" title="Follow Apache Camel on Twitter"><svg focusable="false" class="brand-icon"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#twitter"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://www.linkedin.com/groups/2447439/" title="Apache Camel group on Linkedin"><svg focusable="false" class="brand-icon"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#linkedin"/></svg></a> </div> <button class="navbar-burger" data-target="topbar-nav" type="button" aria-label="Menu"> <span></span> <span></span> <span></span> </button> </div> </nav> </header> <a id="top"></a> <div class="body"> <main role="main blog"> <article class="blog doc"> <header aria-labelledby="title"> <a class="category" href="../../../../categories/Howtos/">HOWTOS</a><a class="category" href="../../../../categories/Camel-K/">CAMEL K</a><a class="category" href="../../../../categories/Test/">TEST</a><a class="category" href="../../../../categories/YAKS/">YAKS</a> <h1 id="title">Testing Camel K with YAKS</h1> </header> <div class="post"> <aside aria-label="Post details"> <div class="summary">How to verify a Camel K integration with YAKS - locally and on cloud infrastructure</div> Posted on <time itemprop="published" datetime="2023-01-31" title="Tuesday, January 31, 2023">January 31, 2023</time>, by <figure> <img src="https://avatars.githubusercontent.com/u/195264?v=4" alt="Christoph Deppisch"> <figcaption rel="author">Christoph Deppisch</figcaption> </figure> <h4>Share this blog</h4> <a class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcamel.apache.org%2fblog%2f2023%2f01%2fcamel-k-yaks%2f" target="_blank" rel="noopener" aria-label="Share on Facebook"> <div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" focusable="false"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg> </div> </div> </a> <a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?text=Testing%20Camel%20K%20with%20YAKS&url=https%3a%2f%2fcamel.apache.org%2fblog%2f2023%2f01%2fcamel-k-yaks%2f&hashtags=ApacheCamel" target="_blank" rel="noopener" aria-label="Share on Twitter"> <div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" focusable="false"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5 0-4.55 2.04-4.55 4.54 0 .36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3 0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35 0 12.92-6.92 12.92-12.93 0-.2 0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg> </div> </div> </a> <a class="resp-sharing-button__link" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fcamel.apache.org%2fblog%2f2023%2f01%2fcamel-k-yaks%2f&title=Testing%20Camel%20K%20with%20YAKS&summary=How%20to%20verify%20a%20Camel%20K%20integration%20with%20YAKS%20-%20locally%20and%20on%20cloud%20infrastructure&source=https%3A%2F%2Fcamel.apache.org" target="_blank" rel="noopener" aria-label="Share on LinkedIn" title="Share on LinkedIn"> <div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" focusable="false"><path d="M6.5 21.5h-5v-13h5v13zM4 6.5C2.5 6.5 1.5 5.3 1.5 4s1-2.4 2.5-2.4c1.6 0 2.5 1 2.6 2.5 0 1.4-1 2.5-2.6 2.5zm11.5 6c-1 0-2 1-2 2v7h-5v-13h5V10s1.6-1.5 4-1.5c3 0 5 2.2 5 6.3v6.7h-5v-7c0-1-1-2-2-2z"/></svg> </div> </div> </a> <p> <a class="arrow prev" href="../../../../blog/2023/01/camel-quarkus-release-2.16.0/" title="Previous post: Camel Quarkus 2.16.0 Released">&#10094;</a> <a class="arrow next" href="../../../../blog/2023/02/RELEASE-4.0.0-M1/" title="Next post: RELEASE 4.0.0-M1">&#10095;</a> </p> </aside> <div class="post-content"> <img class="featured" alt="Blog post featured image" src="../../../../blog/2023/01/camel-k-yaks/featured_hu4d9ba4bfd674bcd554335d3147e6e4b3_106591_800x0_resize_q95_gaussian_3.png" width="800" height="422"> <p>This post describes the steps to test a Camel K integration with YAKS both locally and on the Kubernetes platform.</p> <h1 id="what-is-yaks">What is YAKS?</h1> <p><a href="https://github.com/citrusframework/yaks" rel="noopener nofollow noreferrer">YAKS</a> is an Open Source test automation platform that leverages Behavior Driven Development concepts for running tests locally and on Cloud infrastructure (e.g. <a href="https://kubernetes.io/" rel="noopener nofollow noreferrer">Kubernetes</a> or <a href="https://www.openshift.com/" rel="noopener nofollow noreferrer">OpenShift</a>). This means that the testing tool is able to run your tests both as local tests and natively on Kubernetes. The framework is specifically designed to verify Serverless and Microservice applications and aims for integration testing with the application under test up and running in a production-like environment. A typical YAKS test uses the very same infrastructure as the application under test and exchanges data/events over different messaging transports (e.g. Http REST, Knative eventing, Kafka, JMS and many more).</p> <p>As YAKS itself is written in Java the runtime uses a Java virtual machine with build tools such as Maven and integrates with well known Java testing frameworks such as <a href="https://junit.org/junit5/" rel="noopener nofollow noreferrer">JUnit</a>, <a href="https://cucumber.io/" rel="noopener nofollow noreferrer">Cucumber</a> and <a href="https://citrusframework.org" rel="noopener nofollow noreferrer">Citrus</a> to run the tests.</p> <h1 id="understanding-the-camel-k-example">Understanding the Camel K example</h1> <p>First of all here is a small sample Camel K integration that we would like to test in the following. The integration exposes a Http service to the user. The service accepts client Http POST requests that add fruit model objects. The Camel K route applies content based routing to store the fruits in different AWS S3 buckets.</p> <p><img src="test-scenario.png" alt="Test Scenario"></p> <p>In the test scenario YAKS is going to invoke the Camel K service and verify that the message content has been sent to the right AWS S3 bucket.</p> <p>Here is a sample fruit model object that is subject to be stored in AWS S3:</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Pineapple&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;category&#34;</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="s2">&#34;1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span><span class="s2">&#34;tropical&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;nutrition&#34;</span><span class="p">:{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;calories&#34;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sugar&#34;</span><span class="p">:</span> <span class="mi">9</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;AVAILABLE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;price&#34;</span><span class="p">:</span> <span class="mf">1.59</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;tags&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;sweet&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Here is the Camel K integration route:</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-groovy" data-lang="groovy"><span class="line"><span class="cl"><span class="n">from</span><span class="o">(</span><span class="s1">&#39;platform-http:/fruits&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="s1">&#39;received fruit ${body}&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">unmarshal</span><span class="o">().</span><span class="na">json</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">removeHeaders</span><span class="o">(</span><span class="s2">&#34;*&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s2">&#34;CamelAwsS3Key&#34;</span><span class="o">,</span> <span class="n">constant</span><span class="o">(</span><span class="s2">&#34;fruit.json&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">choice</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">when</span><span class="o">().</span><span class="na">simple</span><span class="o">(</span><span class="s1">&#39;${body[nutrition][sugar]} &lt;= 5&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s2">&#34;CamelAwsS3BucketName&#34;</span><span class="o">,</span> <span class="n">constant</span><span class="o">(</span><span class="s2">&#34;low-sugar&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">when</span><span class="o">().</span><span class="na">simple</span><span class="o">(</span><span class="s1">&#39;${body[nutrition][sugar]} &gt; 5 &amp;&amp; ${body[nutrition][sugar]} &lt;= 10&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s2">&#34;CamelAwsS3BucketName&#34;</span><span class="o">,</span> <span class="n">constant</span><span class="o">(</span><span class="s2">&#34;medium-sugar&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">otherwise</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s2">&#34;CamelAwsS3BucketName&#34;</span><span class="o">,</span> <span class="n">constant</span><span class="o">(</span><span class="s2">&#34;high-sugar&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">end</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">marshal</span><span class="o">().</span><span class="na">json</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="s1">&#39;sending ${body}&#39;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s2">&#34;aws2-s3://noop?$parameters&#34;</span><span class="o">)</span>
</span></span></code></pre></div><p>The route uses content based routing EAP based on the nutrition sugar rating of a given fruit in order to send the fruits to different AWS S3 buckets (low-sugar, medium-sugar, high-sugar).</p> <p>In the following the test case for this integration needs to invoke the exposed service with different fruits and verify its outcome on AWS S3.</p> <h1 id="how-to-test-locally-with-yaks">How to test locally with YAKS</h1> <p>In the beginning let&rsquo;s just write the test and run it locally. For now, we do not care how to deploy the application under test in the Cloud infrastructure as everything is running on the local machine using <a href="https://www.jbang.dev/" rel="noopener nofollow noreferrer">JBang</a>.</p> <p>JBang is a fantastic way to just start coding and running Java code and also Camel K integrations (also see this former blog post about <a href="../../../../blog/2022/11/camel-k-jbang/">how JBang integrates with Camel K</a>).</p> <p>YAKS as a framework brings a set of ready-to-use domain specific languages (XML, YAML, Groovy, BDD Cucumber steps) for writing tests in order to verify your deployed services.</p> <p>This post uses the Behavior Driven Development integration via Cucumber. So the YAKS test is a single feature file that uses BDD Gherkin syntax like this:</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gherkin" data-lang="gherkin"><span class="line"><span class="cl"><span class="k">Feature:</span><span class="nf"> Camel K Fruit Store
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="k">Background:</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    Given </span><span class="nf">URL: http://localhost:</span><span class="s">8080</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Create infrastructure</span><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">    # Start AWS S3 container</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    Given </span><span class="nf">Enable service S</span><span class="s">3</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Given </span><span class="nf">start LocalStack container
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="c">    # Create Camel K integration</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Given </span><span class="nf">Camel K integration property file aws-s</span><span class="s">3</span><span class="nf">-credentials.properties
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">When </span><span class="nf">load Camel K integration fruit-service.groovy
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Then </span><span class="nf">Camel K integration fruit-service should print Started route</span><span class="s">1</span><span class="nf"> (platform-http:///fruits)
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">  </span><span class="k">Scenario:</span><span class="nf"> Verify fruit service</span><span class="c">
</span></span></span><span class="line"><span class="cl"><span class="c">    # Invoke Camel K service</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="k">    Given </span><span class="nf">HTTP request body: yaks:readFile(&#39;pineapple.json&#39;)
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">And </span><span class="nf">HTTP request header Content-Type=&#34;</span><span class="s">application/json</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">When </span><span class="nf">send POST /fruits
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Then </span><span class="nf">receive HTTP </span><span class="s">200</span><span class="nf"> OK
</span></span></span><span class="line"><span class="cl"><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf"></span><span class="c">    # Verify uploaded S3 file</span><span class="nf">
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Given </span><span class="nf">New global Camel context
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Given </span><span class="nf">load to Camel registry amazonS</span><span class="s">3</span><span class="nf">Client.groovy
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Given </span><span class="nf">Camel exchange message header CamelAwsS</span><span class="s">3</span><span class="nf">Key=&#34;</span><span class="s">fruit.json</span><span class="nf">&#34;
</span></span></span><span class="line"><span class="cl"><span class="nf">    </span><span class="k">Given </span><span class="nf">receive Camel exchange from(&#34;</span><span class="s">aws2-s3://medium-sugar?amazonS3Client=#amazonS3Client&amp;deleteAfterRead=true</span><span class="nf">&#34;) with body: yaks:readFile(&#39;pineapple.json&#39;)
</span></span></span></code></pre></div><p>Let’s walk through the test step by step. First of all the feature file uses the usual Given-When-Then BDD syntax to give context, describe the actions and verify the outcome. Each step calls a specific YAKS action that is provided out of the box by the framework. The user is able to choose from a <a href="https://github.com/citrusframework/yaks/tree/main/java/steps" rel="noopener nofollow noreferrer">huge set of steps</a> that automatically perform actions like sending/receiving Http requests/responses, starting <a href="https://www.testcontainers.org/" rel="noopener nofollow noreferrer">Testcontainers</a>, running Camel routes, connecting to a database, publishing events on Kafka or Knative brokers and many more.</p> <p>In the first scenario the test automatically prepares some required infrastructure. The YAKS test starts a Localstack <a href="https://www.testcontainers.org/" rel="noopener nofollow noreferrer">Testcontainer</a> to have an AWS S3 test instance running (<code>Given start LocalStack container</code>). Then the test loads and starts the Camel K integration under test (<code>When load Camel K integration fruit-service.groovy</code>) and waits for it to properly start. In local testing this step starts the Camel K integration using JBang. Later the post will also run the test in a Kubernetes environment.</p> <p>Now the infrastructure is up and running and the test is able to load the fruit model object as Http request body (<code>Given HTTP request body: yaks:readFile('pineapple.json')</code>) and invoke the Camel K service (<code>When send POST /fruits</code>). The test waits for the Http response and verifies its 200 OK status.</p> <p>In the last step the test verifies that the fruit object has been added to the right AWS S3 bucket (medium-sugar). As YAKS itself is not able to connect to AWS S3 the test uses Apache Camel for this step. The test creates a Camel context, loads a AWS client and connects to AWS S3 with a temporary Camel route (<code>Given receive Camel exchange from(&quot;aws2-s3://medium-sugar?amazonS3Client=#amazonS3Client&amp;deleteAfterRead=true&quot;)</code>). With this Apache Camel integration YAKS is able to use the complete 300+ Camel components for sending and receiving messages to various messaging transports. The Camel exchange body should be the same fruit model object (<code>yaks:readFile('pineapple.json'</code>) as posted in the initial Http request.</p> <p>YAKS uses the powerful message payload validation capabilities provided by Citrus for this message content verification. The validation is able to compare message contents of type XML, Json, plaintext and many more.</p> <p>This completes the test case. You can now run this test with Cucumber and JUnit for instance. The easiest way though to directly run tests with YAKS is to use the <a href="https://github.com/citrusframework/yaks/releases" rel="noopener nofollow noreferrer">YAKS command line client</a>. You do not need to set up a whole project with Maven dependencies and so on. Just write the test file and run with:</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ yaks run fruit-service.feature --local
</span></span></code></pre></div><p>You should see some log output like this:</p> <pre tabindex="0"><code>INFO |
INFO | ------------------------------------------------------------------------
INFO |        .__  __
INFO |   ____ |__|/  |________ __ __  ______
INFO | _/ ___\|  \   __\_  __ \  |  \/  ___/
INFO | \  \___|  ||  |  |  | \/  |  /\___ \
INFO |  \___  &gt;__||__|  |__|  |____//____  &gt;
INFO |      \/                           \/
INFO |
INFO | C I T R U S  T E S T S  3.4.0
INFO |
INFO | ------------------------------------------------------------------------
INFO |

Scenario: Create infrastructure # fruit-service.feature:6
  Given URL: http://localhost:8080
  Given Enable service S3
  [...]

Scenario: Verify fruit service # fruit-service.feature:20
  Given URL: http://localhost:8080
  Given HTTP request body: yaks:readFile(&#39;pineapple.json&#39;)
  [...]

Scenario: Remove infrastructure  # fruit-service.feature:31
  Given URL: http://localhost:8080
  Given delete Camel K integration fruit-service
  Given stop LocalStack container

3 Scenarios (3 passed)
18 Steps (18 passed)
0m18,051s


INFO | ------------------------------------------------------------------------
INFO |
INFO | CITRUS TEST RESULTS
INFO |
INFO |  Create infrastructure .......................................... SUCCESS
INFO |  Verify fruit service ........................................... SUCCESS
INFO |  Remove infrastructure .......................................... SUCCESS
INFO |
INFO | TOTAL:	3
INFO | FAILED:	0 (0.0%)
INFO | SUCCESS:	3 (100.0%)
INFO |
INFO | ------------------------------------------------------------------------

3 Scenarios (3 passed)
18 Steps (18 passed)
0m18,051s


Test results: Total: 0, Passed: 1, Failed: 0, Errors: 0, Skipped: 0
    fruit-service (fruit-service.feature): Passed
</code></pre><h1 id="running-yaks-in-the-cloud">Running YAKS in the Cloud</h1> <p>YAKS is able to run tests both locally and as part of a Kubernetes cluster. When running tests on Cloud infrastructure YAKS leverages the Operator SDK and provides a specific operator to manage the test case resources on the cluster. Each time you declare a test in the form of a <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" rel="noopener nofollow noreferrer">custom resource</a> the YAKS operator automatically takes care of preparing the proper runtime in order to execute the test as a Kubernetes Pod.</p> <p>Why would you want to run tests as Cloud-native resources on the Kubernetes platform? Kubernetes has become a standard target platform for Serverless and Microservices architectures. Developing the services is different in many aspects compared to what we have done for decades.</p> <p>Writing a Serverless or Microservices application for instance with Camel K is very declarative. As a developer you just write the Camel route and run it as an integration via the Camel K operator directly on the cluster. The declarative approach as well as the nature of Serverless applications make us rely on a given runtime infrastructure, and it is essential to verify the applications also on that infrastructure. So it is only natural to also move the verifying tests into this very same Cloud infrastructure. This is why YAKS also brings your tests to the Cloud infrastructure for integration and end-to-end testing.</p> <p>So here is how it works. You are able to run the very same YAKS test that has been run locally also as a Pod in Kubernetes.</p> <p>YAKS provides a Kubernetes operator and a set of CRDs (custom resources) that we need to install on the cluster. The best way to install YAKS is to use the <a href="https://operatorhub.io/operator/yaks" rel="noopener nofollow noreferrer">OperatorHub</a> or the yaks CLI tools that you can download from the <a href="https://github.com/citrusframework/yaks/releases" rel="noopener nofollow noreferrer">YAKS GitHub release pages</a>.</p> <p>With the yaks-client binary simply run this install command:</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ yaks install
</span></span></code></pre></div><p>This command prepares your Kubernetes cluster for running tests with YAKS. It will take care of installing the YAKS custom resource definitions, setting up role permissions and creating the YAKS operator in a global operator namespace.</p> <p><strong>Important:</strong> You need to be a cluster admin to install custom resource definitions. The operation needs to be done only once for the entire cluster.</p> <p>Now that the YAKS operator is up and running you can run the very same test from local testing also on the Cloud infrastructure. The only thing that needs to be done is to adjust the Http endpoint URL of the Camel K integration from <code>http://localhost:8080</code> to <code>http://fruit-service.${YAKS_NAMESPACE</code>}</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ yaks run fruit-service.feature
</span></span></code></pre></div><p>Please notice that we have just skipped the <code>--local</code> CLI option. Instead of using local JBang tooling to run the test locally now the YAKS CLI connects to the Kubernetes cluster in order to create the test as a custom resource. From there the YAKS operator takes over preparing the test runtime and running the test as a Pod.</p> <p>But wait! The test did prepare some infrastructure, in particular the Camel K integration and the AWS S3 Localstack Testcontainer instance. How does that work inside Kubernetes? YAKS completely takes care of it. The Camel K integration is run with the Camel K operator running on the same Kubernetes cluster. And the Testcontainer AWS S3 instance is automatically run as a Pod in Kubernetes. Even connection settings are handled automatically. It just works!</p> <p>You will see some similar test log output when running the test remotely and the test performs its actions and its validation exactly the same as locally.</p> <p>You can also review the test Pod outcome with:</p> <div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ yaks ls
</span></span></code></pre></div><p>This is an example output you should get:</p> <pre tabindex="0"><code>NAME           PHASE   TOTAL  PASSED  FAILED  SKIPPED  ERRORS
fruit-service  Passed  3      3       0       0        0
</code></pre><h1 id="demo">Demo</h1> <p>The whole demo code is available on this <a href="https://github.com/christophd/yaks-demo-camel-k" rel="noopener nofollow noreferrer">GitHub repository</a>. It also shows how to integrate the tests in a <a href="https://github.com/christophd/yaks-demo-camel-k/actions" rel="noopener nofollow noreferrer">GitHub CI actions workflow</a>, so you can run the tests automatically with every code change.</p> <h1 id="conclusion">Conclusion</h1> <p>This blog post showed how you can test Camel K integrations locally and in a Cloud infrastructure with YAKS. YAKS as a framework has many more features to offer (Kafka, Knative, OpenAPI, etc.) so this is just the start of a new testing platform for BDD testing in Cloud-native environments!</p> <p>Please give feedback, ideas and of course contributions to this. Feel free to add your thoughts on the YAKS repository by opening <a href="https://github.com/citrusframework/yaks/issues" rel="noopener nofollow noreferrer">new issues</a> or even share your appreciation with a <a href="https://github.com/citrusframework/yaks" rel="noopener nofollow noreferrer">star on GitHub</a>.</p> <div class="related"> <h3 id="related"><a class="anchor" href="#related"></a>Related posts</h3> <article class="blog doc"> <header aria-label="Blog post"> <a href="../../../../blog/2022/11/camel-k-jbang/"><h1>How to test an Integration for Camel K</h1></a> <time itemprop="published" datetime="2022-11-24" title="Thursday, November 24, 2022">November 24, 2022</time>, by <span rel="author">Pasquale Congiusti</span> </header> <p>Testing is probably one of those operations we use to repeat most of the time while building any application. Applications in Camel world are no difference. With the advent of Camel JBang, we have a unified place that can be used to perform our testing/fine tuning locally before moving to a higher environment. During the last years of development, we have noticed that testing or fine tuning an integration directly connected to a Cloud Native environment can result a bit cumbersome.</p> <p><a class="continue" href="../../../../blog/2022/11/camel-k-jbang/">Continue reading &#10095;</a></p> <p> <a class="category" href="../../../../categories/Howtos/">HOWTOS</a><a class="category" href="../../../../categories/Camel-K/">CAMEL K</a><a class="category" href="../../../../categories/Test/">TEST</a><a class="category" href="../../../../categories/JBang/">JBANG</a> </p> </article> <article class="blog doc"> <header aria-label="Blog post"> <a href="../../../../blog/2022/10/camel-k-cicd/"><h1>Camel K CICD</h1></a> <time itemprop="published" datetime="2022-10-06" title="Thursday, October 6, 2022">October 6, 2022</time>, by <span rel="author">Pasquale Congiusti</span> </header> <p>In Camel K version 10, we&rsquo;ve released the CLI `promote feature that provides Camel K an opinionated way of promoting an Integration through the stages of software development. This feature unlock the possibility to combine Camel K with external tooling and let the user develop according to any automated release process. We always ear about CI/CD (Continuous Integration/Continuous Delivery and/or Deployment), and in this blog we&rsquo;re going to see how to make it for any Camel K integration.</p> <p><a class="continue" href="../../../../blog/2022/10/camel-k-cicd/">Continue reading &#10095;</a></p> <p> <a class="category" href="../../../../categories/Howtos/">HOWTOS</a><a class="category" href="../../../../categories/Camel-K/">CAMEL K</a><a class="category" href="../../../../categories/Devops/">DEVOPS</a> </p> </article> <article class="blog doc"> <header aria-label="Blog post"> <a href="../../../../blog/2021/10/managing-kamelets-with-kn/"><h1>Managing Kamelet event sources with kn</h1></a> <time itemprop="published" datetime="2021-10-04" title="Monday, October 4, 2021">October 4, 2021</time>, by <span rel="author">Christoph Deppisch</span> </header> <p>The latest community version of the Knative client v0.26 includes a new kn plugin for managing Kamelets as Knative event sources (GitHub: knative-sandbox/kamelet-plugin-source-kamelet). With the new plugin users of the kn tooling can directly list the available Kamelet sources and bind these Kamelets to Knative resources such as brokers, channels or services. The Kamelets facilitate a whole new world of event source possibilities allowing users to connect to external services (AWS, Twitter, Telegram, Postgres) as part of Knative eventing.</p> <p><a class="continue" href="../../../../blog/2021/10/managing-kamelets-with-kn/">Continue reading &#10095;</a></p> <p> <a class="category" href="../../../../categories/Kamelets/">KAMELETS</a><a class="category" href="../../../../categories/Camel-K/">CAMEL K</a> </p> </article> </div> </div> </div> </article> </main> </div> <div class="footer-tools"> <a title="Improve this document, receive free virtual hugs &hearts;" href="https://github.com/apache/camel-website/edit/main/content/blog/2023/01/camel-k-yaks/index.md">Edit this Page</a> <a href="#top" title="Reach the top of the page">Back to top</a> </div> <footer> <div class="footer"> <figure class="logo"> <img class="logo" src="../../../../_/img/logo-d-a567cee6fa.svg" alt="Apache Camel Logo" aria-label="white silhouette of a camel in front of a sand dune"> </figure> <input id="footer-toggle-overview" type="checkbox" title="Show/Hide Overview section"> <dl> <dt><label for="footer-toggle-overview">Overview</label><label for="footer-toggle-overview">&#65291;</label></dt> <dd><a href="../../../../blog/">Blog</a></dd> <dd><a href="../../../../docs/">Documentation</a></dd> <dd><a href="../../../../community/support/">Community</a></dd> <dd><a href="../../../../download/">Download</a></dd> </dl> <input id="footer-toggle-documentation" type="checkbox" title="Show/Hide Documentation section"> <dl> <dt><label for="footer-toggle-documentation">Documentation</label><label for="footer-toggle-documentation">&#65291;</label></dt> <dd><a href="../../../../manual/">User Manual</a></dd> <dd><a href="../../../../components/next/index.html">Components</a></dd> <dd><a href="../../../../camel-k/next/">Camel-K</a></dd> <dd><a href="../../../../camel-kafka-connector/next/">Camel Kafka Connector</a></dd> <dd><a href="../../../../camel-quarkus/next/">Camel Quarkus</a></dd> <dd><a href="../../../../camel-spring-boot/next/">Camel Spring Boot</a></dd> <dd><a href="../../../../camel-karaf/3.22.x/">Camel Karaf</a></dd> <dd><a href="../../../../manual/faq/index.html">FAQ</a></dd> </dl> <input id="footer-toggle-community" type="checkbox" title="Show/Hide Community section"> <dl> <dt><label for="footer-toggle-community">Community</label><label for="footer-toggle-community">&#65291;</label></dt> <dd><a href="../../../../community/support/">Support</a></dd> <dd><a href="../../../../community/contributing/">Contributing</a></dd> <dd><a href="../../../../community/mailing-list">Mailing Lists</a></dd> <dd><a href="../../../../community/user-stories/">User stories</a></dd> <dd><a href="../../../../community/articles/">Articles</a></dd> <dd><a href="../../../../community/books/">Books</a></dd> <dd><a href="../../../../community/team/">Team</a></dd> </dl> <input id="footer-toggle-about" type="checkbox" title="Show/Hide Acknowledgements section"> <dl> <dt><label for="footer-toggle-about">About</label><label for="footer-toggle-about">&#65291;</label></dt> <dd><a href="../../../../acknowledgments/">Acknowledgments</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/events/current-event.html" title="Apache Events">Apache Events</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/licenses/" title="License">License</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/security/" title="Security">Security</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/foundation/sponsorship.html" title="Sponsorship">Sponsorship</a></dd> <dd><a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/foundation/thanks.html" title="Thanks">Thanks</a></dd> </dl> <p class="remark"> &copy; 2004-2024 The <a href="https://apache.org">Apache Software Foundation</a>.<br> Apache Camel, Camel, Apache, the Apache feather logo, and the Apache Camel project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners. </p> <div class="resources"> <div class="context"> <a href="https://privacy.apache.org/policies/privacy-policy-public.html">Privacy Policy</a> </div> <div class="context"> <a target="_blank" rel="noopener noreferrer nofollow" href="https://www.apache.org/foundation/policies/conduct">Code of Conduct</a> </div> <div class="context"> <a href="../../../../sitemap/">Sitemap</a> </div> </div> <div class="footer-icons"> <a rel="noopener noreferrer nofollow" href="https://github.com/apache/camel/" title="Collaborate on GitHub"><svg class="brand-icon" focusable="false"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#github"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://camel.zulipchat.com" title="Chat on Zulip"><svg class="brand-icon" focusable="false"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#zulip"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://twitter.com/ApacheCamel" title="Follow Apache Camel on Twitter"><svg class="brand-icon" focusable="false"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#twitter"/></svg></a> <a rel="noopener noreferrer nofollow" href="https://www.linkedin.com/groups/2447439/" title="Apache Camel group on Linkedin"><svg class="brand-icon" focusable="false"><use href="../../../../_/img/brand-logos-f2e689f4d4.svg#linkedin"/></svg></a> </div> </div> </footer> <script src="../../../../_/js/vendor/algoliasearch-bad45193e2.js"></script> <script src="../../../../_/js/site-c215fb6972.js"></script> <script async src="../../../../_/js/vendor/highlight-621a10fe1b.js"></script> <script async src="../../../../_/js/vendor/svg4everybody-a0c573f2b9.js"></script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Organization", "name": "Apache Camel", "url": "https:\/\/camel.apache.org\/" , "sameAs": ["https://twitter.com/ApacheCamel"] , "logo": "https:\/\/camel.apache.org\/_\/img\/logo-d.svg" , "description": "Apache Camel ™ is a versatile open-source integration framework based on known Enterprise Integration Patterns. Camel empowers you to define routing and mediation rules in a variety of domain-specific languages, including a Java-based Fluent API, Spring or Blueprint XML Configuration files, and a Scala DSL." } </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "BreadcrumbList", "itemListElement": [{ "@type": "ListItem", "position": 1 , "item": { "@id": "https://camel.apache.org/", "name": "Apache Camel" } },{ "@type": "ListItem", "position": 2 , "item": { "@id": "https://camel.apache.org/blog/", "name": "blog" } },{ "@type": "ListItem", "position": 3 , "item": { "@id": "https://camel.apache.org/blog/2023/", "name": "2023" } },{ "@type": "ListItem", "position": 4 , "item": { "@id": "https://camel.apache.org/blog/2023/01/", "name": "01" } },{ "@type": "ListItem", "position": 5 , "item": { "@id": "https://camel.apache.org/blog/2023/01/camel-k-yaks/", "name": "camel-k-yaks" } }] } </script> </body> </html> 